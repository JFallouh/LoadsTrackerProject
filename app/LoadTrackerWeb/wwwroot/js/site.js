// Please see documentation at https://learn.microsoft.com/aspnet/core/client-side/bundling-and-minification
// for details on configuring this project to bundle and minify static web assets.

// Write your JavaScript code.


(function () {
  const table = document.getElementById("loadsTable");
  if (!table) return;

  const customer = table.dataset.customer;
  const year = parseInt(table.dataset.year, 10);
  const month = parseInt(table.dataset.month, 10);
  const canEdit = table.dataset.canedit === "1";

  // ---------- Column toggles (view only, per-user browser localStorage) ----------
  const storageKey = "lt_columns";
  const toggles = document.querySelectorAll(".column-toggles input[type=checkbox]");

  function applyColumnVisibility(state) {
    toggles.forEach(cb => {
      const col = cb.dataset.col;
      const show = state[col] !== false; // default true
      cb.checked = show;

      // hide/show header + cells
      document.querySelectorAll(`[data-col="${col}"]`).forEach(el => {
        el.style.display = show ? "" : "none";
      });
    });
  }

  let colState = {};
  try { colState = JSON.parse(localStorage.getItem(storageKey) || "{}"); } catch { colState = {}; }
  applyColumnVisibility(colState);

  toggles.forEach(cb => {
    cb.addEventListener("change", () => {
      colState[cb.dataset.col] = cb.checked;
      localStorage.setItem(storageKey, JSON.stringify(colState));
      applyColumnVisibility(colState);
    });
  });

  // ---------- Safe row update (ONLY if server authorizes) ----------
  if (canEdit) {
    table.querySelectorAll("button.save").forEach(btn => {
      btn.addEventListener("click", async () => {
        const tr = btn.closest("tr");
        const id = parseInt(tr.dataset.rowid, 10);

        const ex = tr.querySelector("input.ex").checked;
        const delay = tr.querySelector("input.delay").value;
        const comments = tr.querySelector("input.comments").value;

        // Anti-forgery token is in a hidden input generated by Razor for the page.
        const token = document.querySelector('input[name="__RequestVerificationToken"]');
        const headers = { "Content-Type": "application/json" };
        if (token) headers["RequestVerificationToken"] = token.value;

        const res = await fetch("./Loads/Update", {
          method: "POST",
          headers,
          body: JSON.stringify({
            detailLineId: id,
            exception: ex,
            userNonCarrierDelay: delay,
            comments: comments
          })
        });

        if (!res.ok) {
          alert("Update failed.");
        }
      });
    });
  }

  // ---------- SignalR live refresh ----------
  // NOTE: The browser automatically sends cookies to the hub.
  // The hub validates the user can join only their allowed group.
  const yyyymm = `${year}${String(month).padStart(2, "0")}`;

  // If you don't have signalr.min.js locally, install via LibMan or copy it.
  // For now, this assumes it exists at /lib/signalr/signalr.min.js
  if (window.signalR) {
    const connection = new signalR.HubConnectionBuilder()
      .withUrl("./hubs/loadtracker")
      .build();

    connection.on("rowUpdated", async (detailLineId) => {
      // Refresh just one row (partial view)
      const url = `./Loads/Row?id=${detailLineId}&year=${year}&month=${month}`;
      const html = await fetch(url).then(r => r.ok ? r.text() : null);
      if (!html) return;

      const old = table.querySelector(`tr[data-rowid="${detailLineId}"]`);
      if (!old) return;

      const tmp = document.createElement("tbody");
      tmp.innerHTML = html.trim();
      const newRow = tmp.querySelector("tr");
      if (!newRow) return;

      old.replaceWith(newRow);

      // Re-apply column visibility after row replace
      applyColumnVisibility(colState);
    });

    connection.start()
      .then(() => connection.invoke("JoinGroup", customer, yyyymm))
      .catch(() => { /* ignore */ });
  }
})();
